{% extends "teams/base.html" %}

{% block title %}{{ team.name }}{% endblock %}

{% block content %}


<div class="tabs">
    <button class="tab-button is-active" data-tab="events" type="button">Events</button>
    <button class="tab-button" data-tab="my-events" type="button">My booked events</button>
</div>

<div class="tab-panel is-active" id="events">
    {% if events %}
        <div class="event-list">
            {% for event in events %}
                <article class="event-card">
                    <div class="event-main">
                        <h3><a href="{% url 'teams:event-detail' event.id %}">{{ event.title }}</a></h3>
                        
                        <div class="event-meta">
                            <span>{{ event.starts_at|date:"l j F Y" }}</span>
                            <span>{{ event.starts_at|date:"g:iA" }} - {{ event.ends_at|date:"g:iA" }}</span>
                            {% if event.venue %}
                                <span>{{ event.venue.name }}</span>
                            {% else %}
                                <span class="muted">No venue set</span>
                            {% endif %}
                        </div>

                        <div class="event-stats">
                            <span>{{ event.spots_taken }}/{{ event.max_participants }} spots</span>
                            <span>£{{ event.price|floatformat:2 }}</span>
                        </div>
                    </div>
                    <div class="event-action">
                        <form method="post" action="{% url 'teams:event-signup' event.id %}" class="status-form">
                            {% csrf_token %}
                            {% if event.my_status == 'yes' %}
                                <div class="status-buttons">
                                    <button class="button status-yes is-selected" type="submit" name="status" value="yes" disabled>
                                        <i data-lucide="check"></i>
                                        Booked
                                    </button>
                                    <button class="button ghost status-no" type="submit" name="status" value="no">
                                        Refund &amp; cancel
                                    </button>
                                </div>
                            {% else %}
                                <div class="status-buttons">
                                    {% if event.is_full %}
                                        <button
                                            class="button{% if event.my_status != 'waitlist' %} ghost{% endif %} status-waitlist{% if event.my_status == 'waitlist' %} is-selected{% endif %}"
                                            type="submit"
                                            name="status"
                                            value="waitlist"
                                            {% if event.my_status == 'waitlist' %}disabled{% endif %}
                                        >
                                            {% if event.my_status == 'waitlist' %}
                                                #{{ event.waitlist_count|default:0 }} in waitlist
                                            {% else %}
                                                Join waitlist
                                            {% endif %}
                                        </button>
                                    {% else %}
                                        <button
                                            class="button{% if event.my_status != 'yes' %} ghost{% endif %} status-yes{% if event.my_status == 'yes' %} is-selected{% endif %}"
                                            type="submit"
                                            name="status"
                                            value="yes"
                                            {% if event.my_status == 'yes' %}disabled{% endif %}
                                        >
                                            {% if event.my_status == 'yes' %}
                                                <i data-lucide="check"></i>
                                            {% endif %}
                                            Book now
                                        </button>
                                    {% endif %}
                                    {% if event.my_status != 'waitlist' %}
                                        <button
                                            class="button{% if event.my_status != 'maybe' %} ghost{% endif %} status-maybe{% if event.my_status == 'maybe' %} is-selected{% endif %}"
                                            type="submit"
                                            name="status"
                                            value="maybe"
                                            {% if event.my_status == 'maybe' %}disabled{% endif %}
                                        >
                                            {% if event.my_status == 'maybe' %}
                                                <i data-lucide="help-circle"></i>
                                            {% endif %}
                                            Maybe
                                        </button>
                                        <button
                                            class="button{% if event.my_status != 'no' %} ghost{% endif %} status-no{% if event.my_status == 'no' %} is-selected{% endif %}"
                                            type="submit"
                                            name="status"
                                            value="no"
                                            {% if event.my_status == 'no' %}disabled{% endif %}
                                        >
                                            {% if event.my_status == 'no' %}
                                                <i data-lucide="x"></i>
                                            {% endif %}
                                            No
                                        </button>
                                    {% endif %}
                                </div>
                                {% if event.my_status == 'waitlist' %}
                                    <button class="button ghost status-no leave-waitlist" type="submit" name="status" value="no">
                                        Leave waitlist
                                    </button>
                                {% endif %}
                            {% endif %}
                        </form>
                    </div>
                </article>
            {% endfor %}
        </div>
    {% else %}
        <div class="empty">
            <h2>No events yet</h2>
            <p>Admins can create events to get things moving.</p>
        </div>
    {% endif %}
</div>

<div class="tab-panel" id="my-events">
    {% if my_events %}
        <div class="event-list">
            {% for event in my_events %}
                <article class="event-card">
                    <div class="event-main">
                        <h3><a href="{% url 'teams:event-detail' event.id %}">{{ event.title }}</a></h3>
                        <div class="event-meta">
                            <span>{{ event.starts_at|date:"l j F Y" }}</span>
                            <span>{{ event.starts_at|date:"g:iA" }} - {{ event.ends_at|date:"g:iA" }}</span>
                            {% if event.venue %}
                                <span>{{ event.venue.name }}</span>
                            {% else %}
                                <span class="muted">No venue set</span>
                            {% endif %}
                        </div>
                        <div class="event-stats">
                            <span>{{ event.spots_taken }}/{{ event.max_participants }} spots</span>
                            <span>Min {{ event.min_participants }}</span>
                            <span>£{{ event.price|floatformat:2 }}</span>
                        </div>
                    </div>
                    <div class="event-action">
                        <span class="status success">Booked</span>
                    </div>
                </article>
            {% endfor %}
        </div>
    {% else %}
        <div class="empty">
            <h2>No bookings yet</h2>
            <p>Check the events tab to claim a spot.</p>
        </div>
    {% endif %}
</div>

<script>
    const buttons = document.querySelectorAll(".tab-button");
    const panels = document.querySelectorAll(".tab-panel");

    const activate = (tabId) => {
        buttons.forEach((button) => {
            button.classList.toggle("is-active", button.dataset.tab === tabId);
        });
        panels.forEach((panel) => {
            panel.classList.toggle("is-active", panel.id === tabId);
        });
    };

    buttons.forEach((button) => {
        button.addEventListener("click", () => activate(button.dataset.tab));
    });

    if (window.location.hash) {
        const tabId = window.location.hash.replace("#", "");
        if (document.getElementById(tabId)) {
            activate(tabId);
        }
    }
</script>
{% endblock %}
